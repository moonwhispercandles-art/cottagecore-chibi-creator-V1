<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cottagecore Chibi Maker</title>
    <!-- Load Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Merriweather font for the Cottagecore aesthetic -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght+400;700;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        /* Base font and styling */
        body {
            font-family: 'Merriweather', serif;
            background-color: #f8fcf5; /* Very light, natural background */
            min-height: 100vh;
        }

        /* Custom class to handle asset preview buttons scrolling */
        .asset-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .asset-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Styling for buttons that show an image preview */
        .asset-button-preview {
            width: 72px; /* Slightly larger size */
            height: 72px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 0 !important;
            text-indent: -9999px; /* Hide text, rely on background image */
        }

        /* Selected Button Style */
        .selected-asset {
            border-color: #4CAF50; /* A strong, friendly green */
            background-color: #e6f3e6; /* Light green background */
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5); /* Green ring effect */
            transform: scale(1.05);
        }

        /* Shadow Text for Titles */
        .shadow-text {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- Loading Overlay with Progress Bar -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-2xl font-bold text-green-700 mb-4">Gathering the Chibi Assets...</div>
        <div class="w-64 bg-green-200 rounded-full h-4 shadow-inner">
            <div id="progressBar" class="bg-green-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div id="progressText" class="mt-2 text-green-800 font-medium">0% Loaded</div>
    </div>

    <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-8">
        
        <!-- Character Canvas / Preview Area -->
        <div class="lg:w-1/2 flex flex-col items-center sticky top-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-green-900 mb-4 shadow-text">
                Cottagecore Chibi Maker
            </h1>
            <div class="relative w-full max-w-[500px] aspect-[5/6] border-8 border-green-700 rounded-3xl shadow-2xl bg-white overflow-hidden">
                <canvas id="characterCanvas" width="500" height="600" class="w-full h-full block"></canvas>
            </div>
            
            <!-- Download Button -->
            <button id="downloadButton" class="mt-6 py-3 px-8 bg-pink-500 text-white font-bold rounded-full shadow-lg hover:bg-pink-600 transition duration-200 active:scale-95">
                Download Chibi PNG
            </button>
        </div>

        <!-- Controls / Asset Selection Area -->
        <div id="controlsContainer" class="lg:w-1/2 space-y-6 p-4 bg-white lg:bg-transparent rounded-xl">
            <!-- Asset sections will be generated here by JavaScript -->
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- CONFIGURATION ---
        const CANVAS_WIDTH = 500;
        const CANVAS_HEIGHT = 600;

        // CRITICAL: The correct base URL for your GitHub asset repository.
        const BASE_ASSET_URL = 'https://raw.githubusercontent.com/moonwhispercandles-art/cottagecore-chibi-assets/main/'; 

        // Placeholder URL for buttons that don't have a distinct preview image (like color buttons)
        const BUTTON_PREVIEW_URL = 'https://placehold.co/64x64/a8b98b/fff?text=P'; 

        // --- ASSET MAP: Defines all layers and options ---
        const ASSET_MAP = {
            // NOTE: The 'url' property now just holds the file name, and the script prefixes it with BASE_ASSET_URL
            
            // LAYER 1: BACKGROUNDS
            backgrounds: [
                { name: 'Forest Glade', url: 'Forest Glade.png' },
                { name: 'Rustic Cabin', url: 'Rustic Cabin.png' }, // Updated from 'Cabin Interior'
            ],
            // LAYER 2: BODY / SKIN TONES (Drawn via color for simplicity, names updated)
            bodies: [
                { name: 'Pale', color: '#f7e5d8', url: 'Pale skin tone.png' }, 
                { name: 'Tan', color: '#cc9e7d', url: 'Tan skin tone.png' },
                { name: 'Olive', color: '#b8a594', url: 'Olive skin tone.png' },
                { name: 'Caramel', color: '#d4a373', url: 'Caramel skin tone.png' }
            ], 
            // LAYERS 3-6: OUTFITS, FACE, HAIR, ACCESSORIES (Image files)
            outfits: [
                { name: 'None', url: null },
                { name: 'Frock', url: 'Frock.png' }, // Updated from 'Smock Dress'
                { name: 'Apron & Blouse', url: 'Apron and Blouse.png' },
                { name: 'Jumpsuit', url: 'Jumpsuit.png' },
                // Removed 'Corset Dress' as there was no file match
            ],
            face: {
                eyes: [
                    { name: 'Eyes (Default)', url: 'Eyes 500x600.png' },
                ],
                eyebrows: [
                    { name: 'Angry', url: 'Angry Eyebrow.png' }, // Updated from 'Eyebrows (Angry)'
                    { name: 'Calm', url: 'Calm Eyebrow.png' }, // Updated from 'Eyebrows (Calm)'
                ],
                mouth: [
                    { name: 'Open Mouth', url: 'Open Mouth.png' }, // Updated from 'Lips (Open)'
                    { name: 'Small Lip', url: 'Small Lip.png' }, // Updated from 'Lips (Closed)'
                ],
                nose: [
                    { name: 'Simple Nose', url: 'Nose.png' }, // Updated from 'Nose (Simple)'
                    { name: 'Nose (None)', url: null },
                ],
                ears: [
                    { name: 'Ears (Default)', url: 'Ears 500x600.png' },
                ]
            },
            hairs: [
                { name: 'None', url: null },
                { name: 'Braided Crown', url: 'Braided Crown.png' },
                { name: 'Long & Flowy', url: 'Long Hair.png' }, // Updated from 'Long & Flowy'
                { name: 'Short Pixie', url: 'Pixie Cut.png' }, // Updated from 'Short Pixie'
            ],
            accessories: [
                { name: 'None', url: null },
                { name: 'Flower Crown', url: 'Flower Crown.png' },
                { name: 'Toadstool Cap', url: 'Toadstool Cap.png' }, // Updated from 'Mushroom Hat'
                // Removed 'Woven Basket' as no file was provided
                { name: 'Acorn Necklace', url: 'Acorn Necklace.png' },
                { name: 'Strawberry Earrings', url: 'Strawberry Earring.png' },
                { name: 'Sling Bag', url: 'Sling Bag.png' },
            ],
        };

        // State management: Stores the index of the selected item for each layer
        let characterConfig = {
            background: 0,
            body: 0,
            outfit: 0,
            hair: 0,
            accessory: 0,
            eyes: 0,
            eyebrows: 0,
            mouth: 0,
            nose: 0,
            ears: 0,
        };

        // Stores all loaded Image objects, keyed by their full absolute URL
        const IMAGES = {};
        let imagesToLoad = 0;
        let imagesLoaded = 0;

        // --- DOM References ---
        const canvas = document.getElementById('characterCanvas');
        const ctx = canvas.getContext('2d');
        const controlsContainer = document.getElementById('controlsContainer');
        const loadingOverlay = document.getElementById('loading-overlay');
        const downloadButton = document.getElementById('downloadButton');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');


        // --- IMAGE LOADING LOGIC ---
        function getAbsoluteUrl(filename) {
            if (!filename) return null;
            // Combines the base URL with the filename
            return BASE_ASSET_URL + filename;
        }

        function collectAllImagePaths() {
            const paths = [];
            // Collect all unique URLs from ASSET_MAP
            ['backgrounds', 'bodies', 'outfits', 'hairs', 'accessories'].forEach(category => {
                ASSET_MAP[category].forEach(item => {
                    const absUrl = getAbsoluteUrl(item.url);
                    if (absUrl && !IMAGES[absUrl]) paths.push(absUrl);
                });
            });
            Object.keys(ASSET_MAP.face).forEach(category => {
                ASSET_MAP.face[category].forEach(item => {
                    const absUrl = getAbsoluteUrl(item.url);
                    if (absUrl && !IMAGES[absUrl]) paths.push(absUrl);
                });
            });
            
            return paths;
        }

        function updateProgress() {
            const percent = imagesToLoad > 0 ? Math.floor((imagesLoaded / imagesToLoad) * 100) : 100;
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${percent}% Loaded`;
        }

        function loadImages(callback) {
            const allPaths = collectAllImagePaths();
            imagesToLoad = allPaths.length;

            if (imagesToLoad === 0) {
                if (callback) callback();
                return;
            }

            allPaths.forEach(absUrl => {
                const img = new Image();
                img.crossOrigin = 'Anonymous'; // Required for cross-origin hosting like GitHub Raw
                
                const onAssetLoad = () => {
                    imagesLoaded++;
                    updateProgress();
                    
                    if (imagesLoaded === imagesToLoad && callback) {
                        setTimeout(callback, 300); 
                    }
                };

                img.onload = onAssetLoad;
                img.onerror = () => {
                    console.error(`Failed to load asset: ${absUrl}.`);
                    // Treat failed load as loaded to avoid infinite wait, but logs the error
                    onAssetLoad(); 
                };
                img.src = absUrl;
                IMAGES[absUrl] = img; // Store image object
            });
        }

        // --- CANVAS DRAWING LOGIC ---
        function drawBodyShape(color) {
            // A simple placeholder shape to represent the body color. 
            // This is for visual debugging if the actual body asset is missing.
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(CANVAS_WIDTH / 2, CANVAS_HEIGHT * 0.3, 100, 0, Math.PI * 2);
            ctx.rect(CANVAS_WIDTH / 2 - 50, CANVAS_HEIGHT * 0.4, 100, 150);
            ctx.fill();
        }

        function drawCharacter() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT); 
            
            // 1. Draw Background
            const bgItem = ASSET_MAP.backgrounds[characterConfig.background];
            const bgImg = IMAGES[getAbsoluteUrl(bgItem.url)];
            if (bgImg && bgImg.complete) {
                ctx.drawImage(bgImg, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            } else {
                // Fallback to a solid color
                ctx.fillStyle = '#f0f4e8';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }

            // 2. Draw Body (Skin Tone - using placeholder shape)
            const bodyItem = ASSET_MAP.bodies[characterConfig.body];
            drawBodyShape(bodyItem.color);
            
            // Define the layer order (URL is the key to retrieve the Image object)
            // Layers must be drawn in the correct stacking order: back to front.
            const layers = [];

            // 3. Outfit (Below face, above body)
            layers.push(ASSET_MAP.outfits[characterConfig.outfit].url);

            // 4. Face Parts (Order matters: ears/nose below eyes/mouth)
            layers.push(ASSET_MAP.face.ears[characterConfig.ears].url);
            layers.push(ASSET_MAP.face.nose[characterConfig.nose].url);
            layers.push(ASSET_MAP.face.eyes[characterConfig.eyes].url);
            layers.push(ASSET_MAP.face.eyebrows[characterConfig.eyebrows].url);
            layers.push(ASSET_MAP.face.mouth[characterConfig.mouth].url);
            
            // 5. Hair (On top of face)
            layers.push(ASSET_MAP.hairs[characterConfig.hair].url);
            
            // 6. Accessories (On top of everything else)
            layers.push(ASSET_MAP.accessories[characterConfig.accessory].url);
            
            // Draw all layered items
            layers.forEach(filename => {
                if (filename) {
                    const absUrl = getAbsoluteUrl(filename);
                    const img = IMAGES[absUrl];
                    if (img && img.complete) {
                        // Draw all layered assets at (0, 0)
                        ctx.drawImage(img, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                    }
                }
            });
        }

        // --- UI HELPER FUNCTIONS ---
        function updateSelectedClasses(categoryKey, selectedIndex) {
            const container = document.getElementById(`options-${categoryKey}`);
            if (!container) return;
            
            Array.from(container.children).forEach((child, index) => {
                child.classList.remove('selected-asset');
                if (index === selectedIndex) {
                    child.classList.add('selected-asset');
                }
            });
        }

        function createOptionButton(item, categoryKey, index) {
            const button = document.createElement('button');
            button.textContent = item.name;
            button.className = 'p-2 md:p-3 bg-white border-2 border-green-300 rounded-xl text-green-800 font-medium hover:bg-green-100 transition-all text-sm whitespace-nowrap active:scale-95';

            if (index === characterConfig[categoryKey]) {
                button.classList.add('selected-asset');
            }
            
            // Use color for skin tone preview
            if (categoryKey === 'body' && item.color) {
                button.style.backgroundColor = item.color;
                button.classList.add('w-16', 'h-16', 'border-4');
                button.textContent = item.name.split(' ')[0]; // Use first word for brevity
            } 
            // Use image preview for buttons
            else if (item.url) {
                button.classList.add('asset-button-preview'); 
                const absUrl = getAbsoluteUrl(item.url);
                button.style.backgroundImage = `url(${absUrl})`; 
                button.textContent = ''; // Clear text content for image preview
            }

            button.addEventListener('click', () => {
                characterConfig[categoryKey] = index;
                drawCharacter();
                updateSelectedClasses(categoryKey, index);
            });
            return button;
        }

        function createControlSection(categoryName, categoryKey, items) {
            const section = document.createElement('div');
            section.className = 'border-b border-green-200 pb-4';
            
            section.innerHTML = `
                <h3 class="text-lg font-semibold text-green-700 mb-2 shadow-text">${categoryName}</h3>
                <div id="options-${categoryKey}" class="flex gap-3 overflow-x-auto asset-scroll p-1">
                    <!-- Buttons go here -->
                </div>
            `;
            
            const optionsContainer = section.querySelector(`#options-${categoryKey}`);
            items.forEach((item, index) => {
                const button = createOptionButton(item, categoryKey, index);
                optionsContainer.appendChild(button);
            });
            
            controlsContainer.appendChild(section);
        }
        
        // --- DOWNLOAD FUNCTIONALITY ---
        function downloadCharacter() {
            // Re-draw the character just before downloading to ensure the latest state is captured
            drawCharacter(); 
            
            // Convert canvas to a data URL (PNG format)
            const dataURL = canvas.toDataURL('image/png');
            
            // Create a temporary link element
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'cottagecore_chibi.png'; 
            
            // Trigger the download by simulating a click
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- INITIALIZATION ---
        function initUI() {
            // Initialize all control sections
            createControlSection('Background', 'background', ASSET_MAP.backgrounds);
            createControlSection('Body / Skin Tone', 'body', ASSET_MAP.bodies);
            createControlSection('Outfit', 'outfit', ASSET_MAP.outfits);
            createControlSection('Hair', 'hair', ASSET_MAP.hairs);
            createControlSection('Accessories', 'accessory', ASSET_MAP.accessories);
            
            // Face Parts (Grouped)
            const faceContainer = document.createElement('div');
            faceContainer.className = 'border-b border-green-200 pb-4 space-y-4';
            faceContainer.innerHTML = '<h3 class="text-lg font-semibold text-green-700 mb-2 shadow-text">Facial Features</h3>';
            controlsContainer.appendChild(faceContainer);

            // Dynamic creation for face sub-categories
            Object.keys(ASSET_MAP.face).forEach(key => {
                const faceSection = document.createElement('div');
                const title = key.charAt(0).toUpperCase() + key.slice(1);
                faceSection.innerHTML = `
                    <h4 class="text-sm font-medium text-green-600 mb-1">${title}</h4>
                    <div id="options-${key}" class="flex gap-3 overflow-x-auto asset-scroll p-1"></div>
                `;
                const optionsContainer = faceSection.querySelector(`#options-${key}`);
                ASSET_MAP.face[key].forEach((item, index) => {
                    const button = createOptionButton(item, key, index);
                    optionsContainer.appendChild(button);
                });
                faceContainer.appendChild(faceSection);
            });

            // Attach download listener
            downloadButton.addEventListener('click', downloadCharacter);

            // Initial draw
            drawCharacter();

            // Hide loading overlay 
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
            }, 500);
        }

        // Start the application flow on window load
        window.addEventListener('load', () => {
            loadImages(() => {
                initUI();
            });
        });
    </script>
</body>
</html>
