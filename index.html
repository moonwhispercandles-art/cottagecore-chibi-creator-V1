<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cottagecore Chibi Maker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Merriweather font for the Cottagecore aesthetic -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS (as provided in the style.css) -->
    <style>
        /* Base font and styling */
        body {
            font-family: 'Merriweather', serif;
            background-color: #f8fcf5;
            min-height: 100vh;
        }

        /* Custom class to handle asset preview buttons */
        .asset-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .asset-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .asset-button-preview {
            width: 64px;
            height: 64px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 0 !important;
            text-indent: -9999px; /* Hide text, rely on background image */
        }

        /* Selected Button Style */
        .selected-asset {
            border-color: #4CAF50; /* A stronger green */
            background-color: #e6f3e6; /* Light green background */
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5); /* Green ring effect */
            transform: scale(1.05);
        }

        /* Shadow Text for Titles */
        .shadow-text {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-xl font-bold text-green-700">Loading Assets...</div>
    </div>

    <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-8">
        
        <!-- Character Canvas / Preview Area -->
        <div class="lg:w-1/2 flex flex-col items-center sticky top-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-green-900 mb-4 shadow-text">
                Cottagecore Chibi Maker
            </h1>
            <div class="relative w-full max-w-[500px] aspect-[5/6] border-8 border-green-700 rounded-3xl shadow-2xl bg-white overflow-hidden">
                <canvas id="characterCanvas" width="500" height="600" class="w-full h-full block"></canvas>
            </div>
            
            <!-- Download Button -->
            <button id="downloadButton" class="mt-6 py-3 px-8 bg-pink-500 text-white font-bold rounded-full shadow-lg hover:bg-pink-600 transition duration-200 active:scale-95">
                Download Chibi PNG
            </button>
        </div>

        <!-- Controls / Asset Selection Area -->
        <div id="controlsContainer" class="lg:w-1/2 space-y-6 p-4 bg-white lg:bg-transparent rounded-xl">
            <!-- Asset sections will be generated here by JavaScript -->
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- CONFIGURATION ---
        const CANVAS_WIDTH = 500;
        const CANVAS_HEIGHT = 600;

        // IMPORTANT: The placeholder URL below is used for all asset categories because
        // we cannot load local files in a public sandbox environment (like JSFiddle).
        //
        // <<< ACTION REQUIRED: Replace the GENERIC_PLACEHOLDER_URL with a publicly-hosted URL
        // of one of your chibi images (e.g., your eyes PNG) so the buttons have something to display. >>>
        const GENERIC_PLACEHOLDER_URL = 'https://drive.google.com/uc?export=view&id=1Sbs6VVp7YA1_DznJ8KF_MfnfwE8nB-rF';
        const BUTTON_PREVIEW_URL = 'https://placehold.co/64x64/a8b98b/fff?text=P'; // Used for button images

        const ASSET_MAP = {
            // LAYER 1: BACKGROUNDS
            // <<< PASTE YOUR BACKGROUND IMAGE URLs HERE >>>
            backgrounds: [
                { name: 'Forest Glade', url: 'https://drive.google.com/uc?export=view&id=1x5-cLdObHHPmWo2KMqSQ1bmsbzsnMjYB' },
                { name: 'Cabin Interior', url: 'https://drive.google.com/uc?export=view&id=1Sbs6VVp7YA1_DznJ8KF_MfnfwE8nB-rF' },
            ],
            // LAYER 2: BODY / SKIN TONES (Using colors for simplicity in sandbox)
            bodies: [
                { name: 'Pale', color: '#f7e5d8' }, // Lighter Caramel
                { name: 'Tan', color: '#cc9e7d' },
                { name: 'Olive', color: '#b8a594' },
                { name: 'Caramel', color: '#d4a373' }
            ], 
            // LAYERS 3-6: OUTFITS, FACE, HAIR, ACCESSORIES (Using placeholder image URLs)
            outfits: [
                { name: 'None', url: null },
                // <<< REPLACE THE URLS BELOW WITH YOUR OUTFIT IMAGE LINKS >>>
                { name: 'Smock Dress', url: 'https://drive.google.com/uc?export=view&id=1a0lYgpvJ4sjPRBrvDvnVU1E_gWXvzMKz' },
                { name: 'Apron & Blouse', url: 'https://drive.google.com/uc?export=view&id=1u0Sd1AbI-zqVA-YJk1faLNqcu_ZvoDeh' },
                { name: 'JumpSuit', url: 'https://drive.google.com/uc?export=view&id=1TzwfbEsZRMBy1kJ4a5YaAuiV3iOIi7Y9' },
                { name: 'Corset Dress', url: 'https://drive.google.com/uc?export=view&id=1m5t9-JNQulP_TplFcS9KBbHjLvNvUXwB' },
            ],
            face: {
                eyes: [
                    // <<< REPLACE THE URL BELOW WITH YOUR EYES IMAGE LINK >>>
                    { name: 'Eyes (Default)', url: 'https://drive.google.com/uc?export=view&id=1-ORbNJSRlkHUTFSxRklJW4yAIhGAgen4' }, // e.g., REPLACE with link to 'Eyes.png'
                ],
                eyebrows: [
                    // <<< REPLACE THE URLS BELOW WITH YOUR EYEBROWS IMAGE LINKS >>>
                    { name: 'Eyebrows (Angry)', url: 'https://drive.google.com/uc?export=view&id=1xWSEYGDn8yN8Ldp41FCK0lfpleHraKIa' },
                    { name: 'Eyebrows (Calm)', url: 'https://drive.google.com/uc?export=view&id=1SWsnt7qUdGwyzq9MooFMF-phGjH8A9rE' }, // e.g., REPLACE with link to 'Eyebrow.png'
                ],
                mouth: [
                    // <<< REPLACE THE URLS BELOW WITH YOUR MOUTH/LIPS IMAGE LINKS >>>
                    { name: 'Lips (Open)', url: 'https://drive.google.com/uc?export=view&id=1VBHrvoj50eayNEpdwXhgqWtsdZVqczVw' },
                    { name: 'Lips (Closed)', url: 'https://drive.google.com/uc?export=view&id=1mjpQ1pT_VL9SlLiIzkHIt7Y1NgbRlB6I' }, // e.g., REPLACE with link to 'Mouth.png'
                ],
                nose: [
                    // <<< REPLACE THE URL BELOW WITH YOUR NOSE IMAGE LINK >>>
                    { name: 'Nose (Simple)', url: 'https://drive.google.com/uc?export=view&id=1gfgLgGeU_2RcrxFaHGdd3pkY7J3MtHhf' },
                    { name: 'Nose (None)', url: null },
                ],
                ears: [
                    // <<< REPLACE THE URL BELOW WITH YOUR EARS IMAGE LINK >>>
                    { name: 'Ears (Default)', url: 'https://drive.google.com/uc?export=view&id=1jXD7yuSAZD8b4VxY3KZSg4eLynDu8JIf' }, // e.g., REPLACE with link to 'Ears.png'
                ]
            },
            hairs: [
                { name: 'None', url: null },
                // <<< REPLACE THE URLS BELOW WITH YOUR HAIR IMAGE LINKS >>>
                { name: 'Braided Crown', url: 'https://drive.google.com/uc?export=view&id=1S6RIW17wH9V-ya4A_Tngr95i73hf23R5' },
                { name: 'Long & Flowy', url: 'https://drive.google.com/uc?export=view&id=1ZoF6KBaqfZFOEn5KGWxRvprJh4p8F5Ef' },
                { name: 'Short Pixie', url: 'https://drive.google.com/uc?export=view&id=1koz2LxyqiuTKRnxjYJiNtaNPy9o38eFM' },
            ],
            accessories: [
                { name: 'None', url: null },
                // <<< REPLACE THE URLS BELOW WITH YOUR ACCESSORY IMAGE LINKS >>>
                { name: 'Flower Crown', url: 'https://drive.google.com/uc?export=view&id=1nneCPY4rJNBRlCtWHAPFpmbUhmqZMQ7a' },
                { name: 'Mushroom Hat', url: 'https://drive.google.com/uc?export=view&id=1MwXOm-OgKISzAfRukF_f3rPV77KcNORo' },
                { name: 'Woven Basket', url: 'https://drive.google.com/uc?export=view&id=196SWH7sTrsp3oyPpR8DUbkDufq6XYkQW' },
                { name: 'Acorn Necklace', url: 'https://drive.google.com/uc?export=view&id=1hcdVu6cpY08nwupj8uglb82iaiB-leaP' },
                { name: 'Strawberry Earrings', url: 'https://drive.google.com/uc?export=view&id=1JemJ_x4gv7SbcXx1PkoURVZWRq5ssRT0' },
                { name: 'Sling Bag', url: 'https://drive.google.com/uc?export=view&id=19OyhgtsLPwezdBskk0cwZrhPNUvD9Cl8' },
            ],
        };

        // State management
        let characterConfig = {
            background: 0,
            body: 0,
            outfit: 0,
            hair: 0,
            accessory: 0,
            eyes: 0,
            eyebrows: 0,
            mouth: 0,
            nose: 0,
            ears: 0,
        };

        const IMAGES = {};
        let imagesToLoad = 0;
        let imagesLoaded = 0;

        // --- DOM References ---
        const canvas = document.getElementById('characterCanvas');
        const ctx = canvas.getContext('2d');
        const controlsContainer = document.getElementById('controlsContainer');
        const loadingOverlay = document.getElementById('loading-overlay');
        const downloadButton = document.getElementById('downloadButton');


        // --- IMAGE LOADING LOGIC ---
        function collectAllImagePaths() {
            const paths = [];
            // Collect all unique URLs from ASSET_MAP
            ['backgrounds', 'outfits', 'hairs', 'accessories'].forEach(category => {
                ASSET_MAP[category].forEach(item => {
                    if (item.url && item.url !== GENERIC_PLACEHOLDER_URL && !IMAGES[item.url]) paths.push(item);
                });
            });
            Object.keys(ASSET_MAP.face).forEach(category => {
                ASSET_MAP.face[category].forEach(item => {
                    if (item.url && item.url !== GENERIC_PLACEHOLDER_URL && !IMAGES[item.url]) paths.push(item);
                });
            });

            // Manually add the generic placeholder if not already added, as it's used for drawing and buttons
            const genericItem = { name: 'Placeholder', url: GENERIC_PLACEHOLDER_URL };
            if (!IMAGES[GENERIC_PLACEHOLDER_URL]) paths.push(genericItem);
            
            return paths;
        }

        function loadImages(callback) {
            const allPaths = collectAllImagePaths();
            imagesToLoad = allPaths.length;

            if (imagesToLoad === 0) {
                if (callback) callback();
                return;
            }

            allPaths.forEach(item => {
                const img = new Image();
                img.crossOrigin = 'Anonymous'; // Required for some image hosts
                img.onload = () => {
                    imagesLoaded++;
                    if (imagesLoaded === imagesToLoad && callback) {
                        callback();
                    }
                };
                img.onerror = () => {
                    console.error(`Failed to load: ${item.url}. Using simple placeholder.`);
                    imagesLoaded++;
                    if (imagesLoaded === imagesToLoad && callback) {
                        callback();
                    }
                };
                img.src = item.url;
                IMAGES[item.url] = img; // Store image object
            });
        }

        // --- CANVAS DRAWING LOGIC ---
        function drawBodyShape(color) {
            // Draws a very basic chibi body shape
            ctx.fillStyle = color;
            ctx.beginPath();
            // Head shape - simple circle
            ctx.arc(CANVAS_WIDTH / 2, CANVAS_HEIGHT * 0.3, 100, 0, Math.PI * 2);
            // Body shape - simple rectangle
            ctx.rect(CANVAS_WIDTH / 2 - 50, CANVAS_HEIGHT * 0.4, 100, 150);
            ctx.fill();
        }

        function drawCharacter() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT); 
            
            // 1. Draw Background
            const bgItem = ASSET_MAP.backgrounds[characterConfig.background];
            const bgImg = IMAGES[bgItem.url];
            if (bgImg && bgImg.complete) {
                ctx.drawImage(bgImg, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            } else {
                // Fallback to a solid color if image fails to load
                ctx.fillStyle = '#f0f4e8';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }

            // 2. Draw Body (Skin Tone - using placeholder shape for sandbox compatibility)
            const bodyItem = ASSET_MAP.bodies[characterConfig.body];
            drawBodyShape(bodyItem.color);
            
            // Define the layer order (URL is the key to retrieve the Image object)
            const layers = [];

            // 3. Outfit
            layers.push(ASSET_MAP.outfits[characterConfig.outfit].url);

            // 4. Face Parts (order matters: ears/nose below eyes/mouth)
            layers.push(ASSET_MAP.face.ears[characterConfig.ears].url);
            layers.push(ASSET_MAP.face.nose[characterConfig.nose].url);
            layers.push(ASSET_MAP.face.eyes[characterConfig.eyes].url);
            layers.push(ASSET_MAP.face.eyebrows[characterConfig.eyebrows].url);
            layers.push(ASSET_MAP.face.mouth[characterConfig.mouth].url);
            
            // 5. Hair (Should layer on top of face parts)
            layers.push(ASSET_MAP.hairs[characterConfig.hair].url);
            
            // 6. Accessories (Should layer on top of everything)
            layers.push(ASSET_MAP.accessories[characterConfig.accessory].url);
            
            // Draw all layered items
            layers.forEach(url => {
                if (url) {
                    const img = IMAGES[url];
                    if (img && img.complete) {
                        // Draw all layered assets at (0, 0)
                        ctx.drawImage(img, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                    } else if (url === GENERIC_PLACEHOLDER_URL) {
                        // Draw the generic placeholder if it's the one we expect to fail loading
                        const placeholderImg = IMAGES[GENERIC_PLACEHOLDER_URL];
                        if (placeholderImg && placeholderImg.complete) {
                            ctx.drawImage(placeholderImg, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                        }
                    }
                }
            });
        }

        // --- UI HELPER FUNCTIONS ---
        function updateSelectedClasses(categoryKey, selectedIndex) {
            const container = document.getElementById(`options-${categoryKey}`);
            if (!container) return;
            
            Array.from(container.children).forEach((child, index) => {
                child.classList.remove('selected-asset');
                if (index === selectedIndex) {
                    child.classList.add('selected-asset');
                }
            });
        }

        function createOptionButton(item, categoryKey, index) {
            const button = document.createElement('button');
            button.textContent = item.name;
            button.className = 'p-2 md:p-3 bg-white border border-green-300 rounded-xl text-green-800 font-medium hover:bg-green-100 transition-all text-sm whitespace-nowrap active:scale-95';

            if (index === characterConfig[categoryKey]) {
                button.classList.add('selected-asset');
            }
            
            // Use color for skin tone preview
            if (categoryKey === 'body' && item.color) {
                button.style.backgroundColor = item.color;
                button.classList.add('w-16', 'h-16', 'border-4');
                button.textContent = item.name.split(' ')[0]; // Use first word for brevity
            } 
            // Use image preview for buttons
            else if (item.url) {
                button.classList.add('asset-button-preview'); 
                // Use the item's actual URL for the background if available, otherwise use the placeholder
                const previewUrl = (item.url !== GENERIC_PLACEHOLDER_URL) ? item.url : BUTTON_PREVIEW_URL;
                button.style.backgroundImage = `url(${previewUrl})`; 
                button.textContent = ''; // Clear text content for image preview
            }

            button.addEventListener('click', () => {
                characterConfig[categoryKey] = index;
                drawCharacter();
                updateSelectedClasses(categoryKey, index);
            });
            return button;
        }

        function createControlSection(categoryName, categoryKey, items) {
            const section = document.createElement('div');
            section.className = 'border-b border-green-200 pb-4';
            
            section.innerHTML = `
                <h3 class="text-lg font-semibold text-green-700 mb-2 shadow-text">${categoryName}</h3>
                <div id="options-${categoryKey}" class="flex gap-3 overflow-x-auto asset-scroll p-1">
                    <!-- Buttons go here -->
                </div>
            `;
            
            const optionsContainer = section.querySelector(`#options-${categoryKey}`);
            items.forEach((item, index) => {
                const button = createOptionButton(item, categoryKey, index);
                optionsContainer.appendChild(button);
            });
            
            controlsContainer.appendChild(section);
        }
        
        // --- DOWNLOAD FUNCTIONALITY ---
        function downloadCharacter() {
            // Re-draw the character just before downloading to ensure the latest state is captured
            drawCharacter(); 
            
            // Convert canvas to a data URL (PNG format)
            const dataURL = canvas.toDataURL('image/png');
            
            // Create a temporary link element
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'cottagecore_chibi.png'; 
            
            // Trigger the download by simulating a click
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- INITIALIZATION ---
        function initUI() {
            // Background
            createControlSection('Background', 'background', ASSET_MAP.backgrounds);
            // Body / Skin Tone
            createControlSection('Body / Skin Tone', 'body', ASSET_MAP.bodies);
            // Outfit
            createControlSection('Outfit', 'outfit', ASSET_MAP.outfits);
            // Hair
            createControlSection('Hair', 'hair', ASSET_MAP.hairs);
            // Accessories
            createControlSection('Accessories', 'accessory', ASSET_MAP.accessories);
            
            // Face Parts (Grouped)
            const faceContainer = document.createElement('div');
            faceContainer.className = 'border-b border-green-200 pb-4 space-y-4';
            faceContainer.innerHTML = '<h3 class="text-lg font-semibold text-green-700 mb-2 shadow-text">Facial Features</h3>';
            controlsContainer.appendChild(faceContainer);

            // Dynamic creation for sub-categories
            Object.keys(ASSET_MAP.face).forEach(key => {
                const faceSection = document.createElement('div');
                const title = key.charAt(0).toUpperCase() + key.slice(1);
                faceSection.innerHTML = `
                    <h4 class="text-sm font-medium text-green-600 mb-1">${title}</h4>
                    <div id="options-${key}" class="flex gap-3 overflow-x-auto asset-scroll p-1"></div>
                `;
                const optionsContainer = faceSection.querySelector(`#options-${key}`);
                ASSET_MAP.face[key].forEach((item, index) => {
                    const button = createOptionButton(item, key, index);
                    optionsContainer.appendChild(button);
                });
                faceContainer.appendChild(faceSection);
            });

            // Attach download listener
            downloadButton.addEventListener('click', downloadCharacter);

            // Initial draw
            drawCharacter();

            // Hide loading overlay
            loadingOverlay.classList.add('hidden');
        }

        // Start the application flow
        window.addEventListener('load', () => {
            loadImages(() => {
                initUI();
            });
        });
    </script>
</body>
</html>
